<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>141VYBZ Live</title>
</head>
<body>
  <h1>ðŸ”Š Listening to 141VYBZ</h1>
  <p>Status: <span id="status">Connecting...</span></p>

  <script>
    const status = document.getElementById('status');
    const ws = new WebSocket(location.origin.replace(/^http/, 'ws') + '/stream');
    ws.binaryType = 'arraybuffer';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sampleRate = 44100;

    const speaker = audioCtx.createScriptProcessor(4096, 1, 1);
    speaker.connect(audioCtx.destination);

    let bufferQueue = [];

    speaker.onaudioprocess = (e) => {
      const output = e.outputBuffer.getChannelData(0);
      output.fill(0);

      if (bufferQueue.length) {
        const pcm = bufferQueue.shift();
        for (let i = 0; i < pcm.length && i < output.length; i++) {
          output[i] = pcm[i] / 0x7FFF;
        }
      }
    };

    ws.onmessage = (msg) => {
      const data = new Int16Array(msg.data);
      bufferQueue.push(data);
    };

    ws.onopen = () => {
      status.textContent = "Connected - Listening...";
    };

    ws.onclose = () => {
      status.textContent = "Disconnected";
    };
  </script>
</body>
</html>
