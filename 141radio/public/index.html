<!DOCTYPE html>
<html>
<head>
  <title>Live Stream</title>
</head>
<body>
  <h2>Now Streaming...</h2>
  <button onclick="start()">Listen</button>
  <audio autoplay controls></audio>
  <script>
    function start() {
      const mediaSource = new MediaSource();
      const audio = document.querySelector('audio');
      audio.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener('sourceopen', () => {
        const sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs=opus');
        const socket = new WebSocket(location.origin.replace(/^http/, 'ws') + '/ws');
        socket.binaryType = 'arraybuffer';

        socket.onopen = () => socket.send('ROLE:listener');

        socket.onmessage = (e) => {
          if (sourceBuffer.updating || mediaSource.readyState !== 'open') return;
          sourceBuffer.appendBuffer(new Uint8Array(e.data));
        };
      });
    }
  </script>
</body>
</html>
